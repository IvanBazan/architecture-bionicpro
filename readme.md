
# Задание 1

## Задача 1. Предложить архитектурное решение и доработайть диаграмму C4 для управления учётными данными пользователя. 

**Предпосылки**: 

- Ранее был реализован SSO через Oauth2.0 Code Grant в Keycloak. С тех пор компанию успели взломать. И это даже несмотря на то, что мы использовали Code Grant.
Хакеры воспользовались уязвимостью и скачали персональные данные пользователей по всем протезам. 

- Компания ожидает выход на новые рынки и соблюдение требований законодательства. Компания сейчас работает только в России, но планирует осваивать новые рынки и развивать свои продукты в других странах. BionicPRO работает с медицинскими данными, и во многих странах есть требования к хранению такой информации. Нужно учитывать, что правовое регулирование в разных странах может отличаться. Важно продумать, как будут храниться данные о пациентах, в том числе — авторизационные.

**Требования**:

   -  Произвести унификацию доступа в системе BionicPRO. Это будет осуществляться через запрос данных учётных записей из внешнего источника, который расположен в стране представительства компании. Принципы локального хранения персональной и медицинской информации не должны быть нарушены.
   -  Безопасную схему работы с access- и refresh-токенами, которая исключает передачу фронтенду токенов, которые были получены от IdP.
   -  Возможность поддержки аутентификации пользователей через различные внешние удостоверяющие службы, действующие в разных странах.
  

#### Предлагаемое решение: 

В нашей системе уже развернут SSO c использованием Keycloak.
Будем использовать предоставляемые им возможности

**Реализация "аутентификации пользователей через различные внешние удостоверяющие службы":**

Необходимо в keycloak настроить использование Federated Identity

- В зависимости от страны использования клиента будет редиректить на соответсвующий ей Identity Provider (обозначим *3rdPartyIDP*)
- Пользователь будет авторизоваться и аутентифицироваться в этом 3rdPartyIDP
- 3rdPartyIDP выдает assertion, который распознается и парсится основным IDP
- основной IDP выдает токен для работы с бэком приложения  


Предлагаемая схема
[Диаграмма с SSO](diagrams/BionicPRO_C4_with_FI_keycloak.drawio)

Комментарии:
- Необходимо произвести корректное разделение пользователей системы BionicPRO
  - При текущей архитектуре есть как клиенты-пользователи (конкретные люди), так и клиенты-приложения
  - В частности обращаю внимание на приложение *cli tool* для аналитики данных
  - Данное приложение напрямую обращается к БД где хранятся пользовательские данные
  - Необходимо разобраться ходит ли оно в базу "под своим" пользователем, либо под пользователями конкретных ML инженеров 

![Диаграмма с SSO](diagrams/BionicPRO_C4_with_FI_keycloak.png)

## Задача 2. Улучшите безопасность существующего приложения, заменив Code Grant на PKCE

- во фронте приложения при инициализации Keycloak добавлено `pkceMethod: "S256"` 
  -  фронт приложения генерирует code_challenge и code_verifier при обращении к keycloak
     ```js
        import Keycloak, { KeycloakConfig, KeycloakInitOptions } from 'keycloak-js';

        ...

        const initOptions: KeycloakInitOptions = {
            pkceMethod: "S256"
        }

        const keycloak = new Keycloak(keycloakConfig);

        ...
        <ReactKeycloakProvider authClient={keycloak} initOptions={initOptions}>
        ...
   ```  
-  Конфигурацию самого Keycloak для работы с PKCE можно изменить через GUI админку на вкладке Clients>client-frontend>Advanced
   - затем сделав на этой вкладке Export конфига, понял, как добавить этот параметр в `realm-export.json`:
   ```json
    {
        "clientId": "reports-frontend",
        "enabled": true,
        "publicClient": true,
        "redirectUris": ["http://localhost:3000/*"],
        "webOrigins": ["http://localhost:3000"],
        "directAccessGrantsEnabled": true,
        "attributes": {
          "pkce.code.challenge.method": "S256"
        }
    },
   ```                  